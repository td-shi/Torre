<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Torre</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css" />
    <link rel="stylesheet" href="css/common.css" />
    <link rel="stylesheet" href="css/modal.css" />
    <!-- link rel="manifest" href="manifest.json" / -->
    <script src="https://unpkg.com/maquette@3.3.4/dist/maquette.umd.js"></script>
  </head>
  <body>
    <div id="fused">
      <p>Check:</p>
      <ul>
        <li>The device you want to connect is correct.</li>
        <li>Permissions are allowed to execute javascript.</li>
      </ul>
      <div class="spinner"></div>
    </div>
  <script src="js/gutil.js"></script>
  <script src="js/maqatom.umd.js"></script>
  <script>
    // Make Test
    const listenObject = function(){this._args = {};}
    listenObject.prototype = new EventTarget()
    listenObject.prototype._merge = function(target, source, opts) {
      const isObject = function(obj){ return obj && typeof obj === 'object' && !Array.isArray(obj)};
      const isConcatArray = opts && opts.concatArray;
      let result = Object.assign({}, target);
      if (isObject(target) && isObject(source)) {
        for (const [sourceKey, sourceValue] of Object.entries(source)) {
          const targetValue = target[sourceKey];
          if (isConcatArray && Array.isArray(sourceValue) && Array.isArray(targetValue)) {
            result[sourceKey] = targetValue.concat(Array.prototype.slice.call(sourceValue));
          }
          else if (isObject(sourceValue) && target.hasOwnProperty(sourceKey)) {
            result[sourceKey] = this._merge(targetValue, sourceValue, opts);
          }
          else {
            Object.assign(result, {[sourceKey]: sourceValue});
          }
        }
      }
      return result;
    };
    listenObject.prototype.get = function(key) {
      const propertyArray = key.split('.');
      let result = this._args;

      for (let i = 0; i <= propertyArray.length - 1; i += 1) {
        if (propertyArray[i] === '' ) { return undefined; }
        if (typeof result[propertyArray[i]] === 'undefined') { return undefined; }
        result = result[propertyArray[i]];
      }
      return result;
    };
    listenObject.prototype.set = function(args){
      this._args = this._merge(this._args, args, {concatArray: true})
    }
    listenObject.prototype.overWrite = function(args){
      this._args = args
    }
    function createListen(args = {}){
      let l = new listenObject()
      l._args = args;
      return l;
    }

    // Static utility.
    const vPage = maquette.createProjector();
    const h = maquette.h;
    const mN = maquette.createMetaNode;

    // Static variable.
    const UNID = gU.genUniqs();

    let appArgs = {
      busy: false
    }
    let gameDB = createListen({torre: {gold: 1000, treasure: 0, force: 0, floor: [], past: 20}})
    let currentContents = mN(function(args){
      return h('div#fused',{}, [
        h('p', {}, ["Check:"]),
        h('ul',{}, [
          h('li', {}, ["The device you want to connect is correct."]),
          h('li', {}, ["Permissions are allowed to execute javascript."])
        ]),
        h('div.spinner')
      ]);
    });

    function onNextResult(e){
      console.log(e.currentTarget.value)
      currentContents = result
    }

    function onNextMenu(e){
      console.log(e.currentTarget.value)
      currentContents = menu
    }
    
    function onOpenModal(e){
      modal.setArgs({visible: true, action: function(e){}})
    }

    // Organism component.
    // There should return an object contain .render() which return the VNode (maquette's object from h()).

    var actSelect = mN(function(args){return h('ul.actSelect');})
    actSelect.addNode(mN(function(args){return h('li',{}, [h('button', {onclick: onNextResult, value: String(args.text)}, [String(args.text)])]);} , {text: "result"}));
    actSelect.addNode(mN(function(args){return h('li',{}, [h('button', {onclick: onOpenModal, value: String(args.text)}, [String(args.text)])]);}, {text:"Build up"}));

    var troopResult = mN(function(args){return h('ul.troopResult');})
    troopResult.addNode(mN(function(args){return h('li',{}, [h('span', {}, [String(args.text)])]);}, {text:"OK"}));
    troopResult.addNode(mN(function(args){return h('li',{}, [h('button', {onclick: onNextMenu, value: String(args.text)}, [String(args.text)])]);} , {text: "menu"}));

    var menu = mN(function(args){return h('div.menu');});
    menu.add(mN(function(args){return h('p', {}, ["batler info"]);}))
    menu.add(actSelect)
    menu.add(mN(function(args){
      return h('ul.system', {}, [
        h('li', {}, [h('button', {}, ["Profile"])]),
        h('li', {}, [h('button', {}, ["Nickname"])]),
        h('li', {}, [h('button', {}, ["Abandon"])]),
      ]);
    }))

    var result = mN(function(args){return h('div.result');});

    var modal = mN(function(args){
      let visible = args.visible

      function onCancel(e){
        modal.setArgs({visible: false, action: function(e){}})
      }

      function onAction(e){
        args.action(e)
        modal.setArgs({visible: false, action: function(e){}})
      }
    
      return h('div.modal', {style: "display: " + (visible? "block;": "none;")},[
        h('div.modal-content', {},[
          h('div.modal-header', {}, [
            h('span.close', {onclick: onCancel}, ["X"]),
            h('h2', {}, ["Modal Header"])
          ]),
          h('div.modal-body', {}, [
            h('p', {}, ["Modal body"])
          ]),
          h('div.modal-footer', {}, [
            h('h3', {}, ["Modal footer"]),
            h('button', {onclick: onCancel}, ["Cancel"]),
            h('button', {onclick: onAction}, ["OK"])
          ])
        ])
      ]);
    }, {visible: false, action: function(e){}})

    var mainContents = mN(function(args){return h('main');})
    mainContents.addNode(mN(function(args){return h('div.contents', {}, [currentContents.render()]);}));
    mainContents.addNode(mN(function(args){return h('div.spinner', {style: "display: " + ((appArgs.busy) ? "block;": "none;")}, []);}));
    mainContents.addNode(modal);

    // Create page contents.
    // There are called only the page render.
    // There should be an object contain .frame() which return VNode (maquette's object from h()).

    var tHeader = {
      frame: function(){
        return h('header', {}, [""]);
      }
    };

    var tMain = {
      frame: function(){return mainContents.render();}
    }

    var tFooter = {
      fixed: h('footer', {}, [
          h('hr.theme-color', {}, []),
          h('p', {}, [
            h('small', {}, [
              "2021 TD-shi PD(CC0). ",
              "OSS are ",
              maquette.atomAnchor("https://maquettejs.org", "Maquette", ".oss"),
              " and ",
              maquette.atomAnchor("https://github.com/hankchizljaw/modern-css-reset", "Modern CSS reset", ".oss"),
              ". "
            ])
          ])
        ]),
      frame: function(){ return tFooter.fixed;}
    };

    // Page. Start the page rendering.
    document.addEventListener('DOMContentLoaded', function(){
      document.getElementById('fused').remove();
      currentContents = menu

      if(gU.storageAvailable('localStorage')){
        let torre = gU.getItemLsf('TORRE');

        //if(torre){
        //  gameDB.set(JSON.parse(torre));
        //}
      }
      else{
        confirm("Your browser storage is not available.");
      }

      vPage.append(document.body, tHeader.frame);
      vPage.append(document.body, tMain.frame);
      vPage.append(document.body, tFooter.frame);
    });
/*
    if ('serviceWorker' in navigator) {
     navigator.serviceWorker.register('sw.js')
      .then(
      function (registration) {
          if (typeof registration.update == 'function') {
              registration.update();
          }
      })
      .catch(function (error) {
        console.log("Error Log: " + error);
      });
    }
*/
  </script>
  </body>
</html>
