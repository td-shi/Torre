<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Torre</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css" />
    <link rel="stylesheet" href="css/common.css" />
    <link rel="manifest" href="manifest.json" />
    <script src="https://unpkg.com/maquette@3.3.4/dist/maquette.umd.js"></script>
  </head>
  <body>
    <div id="fused">
      <p>Check:</p>
      <ul>
        <li>The device you want to connect is correct.</li>
        <li>Permissions are allowed to execute javascript.</li>
      </ul>
      <div class="spinner"></div>
    </div>
  <script src="js/gutil.js"></script>
  <script src="js/maqatom.umd.js"></script>
  <script>
    // Static utility.
    const vPage = maquette.createProjector();
    const h = maquette.h;
    const mN = maquette.createMetaNode;

    // Static variable.
    const UNID = gU.genUniqs();

    let appArgs = {
      busy: false
    }
    let noDB = {
      torre: null
    }
    let currentContents = mN(function(args){
      return h('div#fused',{}, [
        h('p', {}, ["Check:"]),
        h('ul',{}, [
          h('li', {}, ["The device you want to connect is correct."]),
          h('li', {}, ["Permissions are allowed to execute javascript."])
        ]),
        h('div.spinner')
      ]);
    });

    function onNextResult(e){
      console.log(e.target.value)
      currentContents = result
    }

    function onNextMenu(e){
      console.log(e.target.value)
      currentContents = menu
    }

    // Organism component.
    // There should return an object contain .render() which return the VNode (maquette's object from h()).
    var menu = mN(function(args){return h('ul');});
    menu.addNode(mN(function(args){return h('li',{}, [h('button', {onclick: onNextResult, value: String(args.text)}, [String(args.text)])]);} , {text: "result"}));
    menu.addNode(mN(function(args){return h('li',{}, [h('span', {}, [String(args.text)])]);}, {text:"Build up"}));

    var result = mN(function(args){return h('ul');});
    result.addNode(mN(function(args){return h('li',{}, [h('span', {}, [String(args.text)])]);}, {text:"OK"}));
    result.addNode(mN(function(args){return h('li',{}, [h('button', {onclick: onNextMenu, value: String(args.text)}, [String(args.text)])]);} , {text: "menu"}));

    var mainContents = mN(function(args){return h('main');})
    mainContents.addNode(mN(function(args){return h('div.contents', {}, [currentContents.render()]);}));
    mainContents.addNode(mN(function(args){return h('div.spinner', {style: "display: " + ((appArgs.busy) ? "block;": "none;")}, []);}));

    // Create page contents.
    // There are called only the page render.
    // There should be an object contain .frame() which return VNode (maquette's object from h()).

    var tHeader = {
      frame: function(){
        return h('header', {}, [""]);
      }
    };

    var tMain = {
      frame: function(){return mainContents.render();}
    }

    var tFooter = {
      fixed: h('footer', {}, [
          h('hr.theme-color', {}, []),
          h('p', {}, [
            h('small', {}, [
              "2021 TD-shi PD(CC0). ",
              "OSS are ",
              maquette.atomAnchor("https://maquettejs.org", "Maquette", ".oss"),
              " and ",
              maquette.atomAnchor("https://github.com/hankchizljaw/modern-css-reset", "Modern CSS reset", ".oss"),
              ". "
            ])
          ])
        ]),
      frame: function(){ return tFooter.fixed;}
    };

    // Page. Start the page rendering.
    document.addEventListener('DOMContentLoaded', function(){
      document.getElementById('fused').remove();

      if(gU.storageAvailable('localStorage')){
        let torre = gU.getItemLsf('TORRE');

        if(torre){
          noDB.torre = JSON.parse(torre);
        }
      }
      else{
        confirm("Your browser storage is not available.");
      }

      vPage.append(document.body, tHeader.frame);
      vPage.append(document.body, tMain.frame);
      vPage.append(document.body, tFooter.frame);
    });

    if ('serviceWorker' in navigator) {
     navigator.serviceWorker.register('sw.js')
      .then(
      function (registration) {
          if (typeof registration.update == 'function') {
              registration.update();
          }
      })
      .catch(function (error) {
        console.log("Error Log: " + error);
      });
    }
  </script>
  </body>
</html>
